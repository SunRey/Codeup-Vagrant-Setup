---
- name: Site Create
  hosts: all
  sudo: yes

  vars_files:
  - "vars/{{ inventory_hostname }}.yml"

  tasks:
  - name: Create site directory
    file: path={{ www_home }}/{{ domain }} state=directory owner=www-data group=www-data mode=0755

  - name: Ensure directory permissions persit
    command: chmod -R g+rws {{ www_home }}/{{ domain }}

  - name: Deploy nginx site config
    template: src=templates/nginx-site.conf.j2 dest=/etc/nginx/sites-available/{{ domain }}
    notify:
      - restart nginx

  - name: Activate nginx site
    file: src=/etc/nginx/sites-available/{{ domain }} dest=/etc/nginx/sites-enabled/{{ domain }} state=link
    notify:
      - restart nginx

  - name: Deploy php-fpm pool config
    template: src=templates/php-fpm-pool.conf.j2 dest=/etc/php5/fpm/pool.d/{{ domain }}.conf
    notify:
      - restart php-fpm

  - include: tasks/git_deploy.yml
    when: git_create

  - name: Add entry to local hosts file
    local_action: 'lineinfile dest=/etc/hosts line="{{ ansible_ssh_host }} {{ domain }}" regexp="{{ domain }}$"'
    when: append_host is defined and append_host

  handlers:
  - include: handlers.yml